import machine
import neopixel
import time

# LED矩阵配置
LED_PIN = 6
NUM_LEDS = 256  # 16x16矩阵
BRIGHTNESS = 0.9  # 亮度 (0.0-1.0)

# 初始化NeoPixel
np = neopixel.NeoPixel(machine.Pin(LED_PIN), NUM_LEDS)

# 32位格式的单帧数据 (0x00RRGGBB 格式)
frame_data = [
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00555555, 0x00555555, 
    0x00555555, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00555555, 0x00000000, 
    0x00000000, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00000000, 0x00000000, 
    0x00000000, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00555555, 0x00000000, 
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000
]

def display_frame():
    """显示单帧图像"""
    # 清除所有LED
    np.fill((0, 0, 0))
    
    # 逐行处理数据
    for row in range(16):
        for col in range(16):
            # 计算在数据数组中的位置
            data_index = (row * 16) + col
            
            # 读取32位颜色值 (格式: 0x00RRGGBB)
            color_data = frame_data[data_index]
            
            # 提取RGB分量
            r = (color_data >> 16) & 0xFF  # 红色分量
            g = (color_data >> 8) & 0xFF   # 绿色分量
            b = color_data & 0xFF          # 蓝色分量
            
            # 应用亮度调整
            r = int(r * BRIGHTNESS)
            g = int(g * BRIGHTNESS)
            b = int(b * BRIGHTNESS)
            
            # 计算LED索引 - 简单行优先顺序
            led_index = get_led_index(row, col)
            
            # 设置LED颜色 (NeoPixel使用RGB顺序)
            np[led_index] = (r, g, b)
    
    # 更新显示
    np.write()
    
    print("Frame displayed successfully")
    print(f"Color 0x00555555 = R:{(0x00555555 >> 16) & 0xFF} G:{(0x00555555 >> 8) & 0xFF} B:{0x00555555 & 0xFF}")

def get_led_index(row, col):
    """计算LED索引 - 简单行优先顺序"""
    return (row * 16) + col

def test_led_connection():
    """测试LED连接和方向"""
    print("Testing LED connection...")
    
    # 测试1: 显示网格边框
    np.fill((0, 0, 0))
    for row in range(16):
        for col in range(16):
            index = get_led_index(row, col)
            if row == 0 or row == 15 or col == 0 or col == 15:
                np[index] = (0, 0, 100)  # 蓝色边框
    np.write()
    print("Blue border displayed - check if corners are correct")
    time.sleep(2)
    
    # 测试2: 显示对角线
    np.fill((0, 0, 0))
    for i in range(16):
        index1 = get_led_index(i, i)       # 主对角线
        index2 = get_led_index(i, 15-i)    # 副对角线
        np[index1] = (100, 0, 0)          # 红色
        np[index2] = (0, 100, 0)          # 绿色
    np.write()
    print("Red and Green diagonals displayed")
    time.sleep(2)
    
    # 清除
    np.fill((0, 0, 0))
    np.write()
    time.sleep(0.5)

def main():
    """主函数"""
    print("32-bit Frame Display for ESP32-S3")
    
    # 可选：先测试LED连接
    # test_led_connection()
    
    # 显示单帧
    display_frame()
    
    # 保持显示
    while True:
        time.sleep(1)

# 运行主程序
if __name__ == "__main__":
    main()
